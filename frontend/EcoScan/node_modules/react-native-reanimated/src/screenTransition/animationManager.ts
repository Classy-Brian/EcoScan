'use strict';

import type { LockAxis, ScreenTransitionConfig } from 'react-native-reanimated/src/screenTransition/commonTypes';
import { configureProps } from 'react-native-reanimated/src/ConfigHelper';
import { applyStyle } from 'react-native-reanimated/src/screenTransition/styleUpdater';
import { getSwipeSimulator } from 'react-native-reanimated/src/screenTransition/swipeSimulator';

configureProps();

export function startScreenTransition(
  screenTransitionConfig: ScreenTransitionConfig
) {
  'worklet';
  const { stackTag, sharedEvent } = screenTransitionConfig;
  sharedEvent.addListener(stackTag, () => {
    applyStyle(screenTransitionConfig, sharedEvent.value);
  });
}

function getLockAxis(goBackGesture: string): LockAxis {
  'worklet';
  if (['swipeRight', 'swipeLeft', 'horizontalSwipe'].includes(goBackGesture)) {
    return 'x';
  } else if (
    ['swipeUp', 'swipeDown', 'verticalSwipe'].includes(goBackGesture)
  ) {
    return 'y';
  }
  return undefined;
}

export function finishScreenTransition(
  screenTransitionConfig: ScreenTransitionConfig
) {
  'worklet';
  const { stackTag, sharedEvent, goBackGesture } = screenTransitionConfig;
  sharedEvent.removeListener(stackTag);
  const lockAxis = getLockAxis(goBackGesture);
  const step = getSwipeSimulator(
    sharedEvent.value,
    screenTransitionConfig,
    lockAxis
  );
  step();
}
